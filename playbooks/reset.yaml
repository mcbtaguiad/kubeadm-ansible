# ============================================================================ #
# Author: Mark Taguiad <marktaguiad@tagsdev.xyz>
# ============================================================================ #
- hosts: all
  become: true
  vars:
    HOST_COUNT: "{{ ansible_play_hosts | length }}"
    MASTER_IP: "{{ hostvars['master1']['ansible_default_ipv4']['address'] }}"
# ============================================================================ #
  tasks:
  - name: Init first cluster member
    # Run this only on the first node in the inventory
    changed_when: false
    register: join_commands
    shell: |-
      kubeadm reset -f &&
    when: inventory_hostname == hostvars[inventory_hostname].groups.all[0]
    ignore_errors: True
# ============================================================================ #
  - name: Ensure nfs-server and iscsi is disabled
    systemd:
      name: "{{ item }}"
      state: stopped
      enabled: true
    with_items:
    # - nfs-server
    - iscsi
    - kubelet
    - containerd
    ignore_errors: True
# ============================================================================ #
  - name: Disable kernel module iscsi_tcp
    community.general.modprobe:
      name: "{{ item }}"
      state: absent
    with_items:
    - iscsi_tcp
    - br_netfilter
# ============================================================================ #
  - name: Disable ipv4 ip forward
    ansible.posix.sysctl:
      name: net.ipv4.ip_forward
      value: '0'
      sysctl_set: true
      state: present
      reload: true
# ============================================================================ #
  - name: Remove installed packages
    package:
      name: "{{ item }}"
      state: absent
      # update_cache: yes
    with_items:
    - iscsi-initiator-utils
    - cryptsetup
    # - nfs-utils
    - lvm2
    - containerd.io
    - kubelet
    - kubeadm
    - kubectl
# ============================================================================ #
  - name: Remove file (delete file)
    ansible.builtin.file:
      path: "{{ item }}"
      state: absent
    with_items:
    - /etc/iscsi/initiatorname.iscsi
# ============================================================================ #
  - name: Remove CNI plugijn
    ansible.builtin.file:
      path: /opt/cni/bin/
      state: absent
# ============================================================================ #
  - name: Remove hostname to /etc/hosts
    lineinfile:
      dest: /etc/hosts
      regexp: '.*{{ item }}$'
      line: '{{ hostvars[item].ansible_default_ipv4.address }} {{item}}'
      state: absent
    with_items: '{{ groups["all"] }}'
# ============================================================================ #
  - name: Remove Kubernetes repository 
    ansible.builtin.yum_repository:
      name: Kubernetes
      state: absent
# ============================================================================ #
  - name: Get swap disk
    shell: |-
      fdisk -l | grep swap | awk '{ print $2 }' | sed 's/\://' 
    register: SWAP_DISK
  # - name: Get UUID
  #   shell: |-
  #     blkid {{SWAP_FS.stdout}} | awk '{ print $2}'
  #   register: SWAP_UUID
# ============================================================================ #
  - name: Mount swap
    mount:
      src: "{{SWAP_DISK.stdout}}"
      path: swap
      fstype: swap
      opts: defaults
      state: present
# ============================================================================ #
  - name: Enable swap
    ansible.builtin.shell: swapon -a
# ============================================================================ #
  - name: Close firewall ports
    ansible.posix.firewalld:
      permanent: yes
      immediate: yes
      port: "{{item.port}}/{{item.proto}}"
      state: "{{item.state}}"
      zone: "{{item.zone}}"
    with_items:
    - description: etcd - client communication - control-plane
      port: 2379
      proto: tcp
      state: disabled
      zone: public
    - description: etcd - peer communication - control-plane
      port: 2380
      proto: tcp
      state: disabled
      zone: public
    - description: platform Agent
      port: 8090-8091
      proto: tcp
      state: disabled
      zone: public
    - description: VxLAN backend 
      port: 8472
      proto: udp
      state: disabled
      zone: public
    - description: kube-apiserver - control-plane
      port: 6443
      proto: tcp
      state: disabled
      zone: public
    - description: kubelet - all nodes
      port: 10250-10259
      proto: tcp
      state: disabled
      zone: public
    - description: kubelet - nodeport
      port: 30000-32767
      proto: tcp
      state: disabled
      zone: public
    - description: calico BGP
      port: 179
      proto: tcp
      state: disabled
      zone: public
    - description: calico VXLAN
      port: 4789
      proto: udp
      state: disabled
      zone: public
    - description: calico Typha
      port: 5473
      proto: tcp
      state: disabled
      zone: public
    - description: calico Wireguard
      port: 51820-51821 
      proto: udp
      state: disabled
      zone: public
    - description: ingress http
      port: 80
      proto: tcp
      state: disabled
      zone: public
    - description: ingress https
      port: 443
      proto: tcp
      state: disabled
      zone: public
    - description: ingress 8443
      port: 8443
      proto: tcp
      state: disabled
      zone: public
    ignore_errors: True